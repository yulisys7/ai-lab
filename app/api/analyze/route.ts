import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

const prompts = {
  bookshelf: `ë‹¹ì‹ ì€ í•œêµ­ì–´ ì±… ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì´ ì±…ì¥ ì‚¬ì§„ì„ ë§¤ìš° ì •ë°€í•˜ê²Œ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ë¶„ì„ ë‹¨ê³„:**
1ë‹¨ê³„: ì‚¬ì§„ì„ ì²œì²œíˆ ìŠ¤ìº”í•˜ë©´ì„œ ëª¨ë“  ì±…ë“±ê³¼ í‘œì§€ë¥¼ ì½ìŠµë‹ˆë‹¤
2ë‹¨ê³„: í•œê¸€, ì˜ì–´ ì œëª©ì„ ëª¨ë‘ ì •í™•íˆ ì½ì–´ëƒ…ë‹ˆë‹¤
3ë‹¨ê³„: ì‹œë¦¬ì¦ˆë¬¼ì€ (ì „ì§‘/ì‹œë¦¬ì¦ˆ)ë¡œ í‘œì‹œí•©ë‹ˆë‹¤

ğŸ“š **ì¸ì‹ëœ ì±… ëª©ë¡** (ì™¼ìª½ë¶€í„° ì˜¤ë¥¸ìª½ìœ¼ë¡œ)
- ì •í™•íˆ ì½ì„ ìˆ˜ ìˆëŠ” ëª¨ë“  ì œëª© ë‚˜ì—´
- ë¶ˆí™•ì‹¤í•œ ê²ƒë„ [ì¶”ì •: ...] í˜•íƒœë¡œ ì–¸ê¸‰
- ìµœì†Œ 10ê¶Œ ì´ìƒ ì°¾ì•„ì£¼ì„¸ìš”

ğŸ§  **ë…ì„œ ì„±í–¥ ë¶„ì„**
- ì¥ë¥´ ë¹„ìœ¨: ê³¼í•™ X%, ì¸ë¬¸ Y%, ì˜ˆìˆ  Z%
- íŠ¹ì§•: êµ¬ì²´ì ìœ¼ë¡œ 3ê°€ì§€
- ì´ ì‚¬ëŒì˜ ì§€ì  ê´€ì‹¬ì‚¬ ë¶„ì„

ğŸ’¡ **ë§ì¶¤ ì¶”ì²œ 3ê¶Œ**
- ìœ„ ì¥ë¥´ì™€ ì—°ê´€ë˜ë˜, ìƒˆë¡œìš´ ì‹œê° ì œê³µ
- ê° ì±…ë§ˆë‹¤ "ì™œ ì¶”ì²œí•˜ëŠ”ì§€" 2ì¤„ ì„¤ëª…

ğŸ¯ **ì„œì¬ í‰ê°€**
- ì¥ì  1ê°€ì§€, ë³´ì™„í•˜ë©´ ì¢‹ì„ ì  1ê°€ì§€

**ì£¼ì˜**: ì ˆëŒ€ ì¶”ì¸¡í•˜ì§€ ë§ˆì„¸ìš”. ì½íˆëŠ” ê²ƒë§Œ ì–¸ê¸‰í•˜ì„¸ìš”!`,

  fridge: `ë‹¹ì‹ ì€ ì „ë¬¸ ì…°í”„ì…ë‹ˆë‹¤. ì´ ëƒ‰ì¥ê³  ì‚¬ì§„ì„ ë§¤ìš° ìì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ì¤‘ìš”**: ì‹¤ì œë¡œ ì‚¬ì§„ ì†ì— ë³´ì´ëŠ” ì¬ë£Œë§Œ ì–¸ê¸‰í•˜ì„¸ìš”.

ğŸ¥— **ë°œê²¬ëœ ì¬ë£Œë“¤** (ì‚¬ì§„ì—ì„œ í™•ì‹¤íˆ ë³´ì´ëŠ” ê²ƒë§Œ)
- ê° ì¬ë£Œë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ë‚˜ì—´
- ì‹ ì„ ë„ ìƒíƒœë„ í•¨ê»˜ ì–¸ê¸‰
   
ğŸ‘¨â€ğŸ³ **ë§Œë“¤ ìˆ˜ ìˆëŠ” ìš”ë¦¬ 3ê°€ì§€**
- ìœ„ì—ì„œ ë°œê²¬í•œ ì¬ë£Œë¡œë§Œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ê²ƒ
- ë‚œì´ë„: ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€
- ì¡°ë¦¬ì‹œê°„: êµ¬ì²´ì ìœ¼ë¡œ (ì˜ˆ: 15ë¶„)
- ê°„ë‹¨í•œ ì¡°ë¦¬ë²•ë„ ì¶”ê°€
   
âš ï¸ **ëƒ‰ì¥ê³  ìƒíƒœ ì²´í¬**
- ìœ í†µê¸°í•œì´ ê±±ì •ë˜ëŠ” ì¬ë£Œ
- ë¶€ì¡±í•œ ê¸°ë³¸ ì¬ë£Œ
- ì •ë¦¬ ìƒíƒœ í‰ê°€
   
ğŸ’¬ **í•œ ì¤„ í‰ê°€**

ë§Œì•½ ì¬ë£Œê°€ ì˜ ì•ˆ ë³´ì´ë©´ "ë‚´ìš©ë¬¼ì´ ëª…í™•íˆ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤"ë¼ê³  ë§í•´ì£¼ì„¸ìš”.`,

  closet: `ë‹¹ì‹ ì€ íŒ¨ì…˜ ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì´ ì˜·ì¥ ì‚¬ì§„ì„ ë§¤ìš° ìì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”.

**ì¤‘ìš”**: ì‹¤ì œë¡œ ì‚¬ì§„ ì†ì— ë³´ì´ëŠ” ì˜·ë§Œ ì–¸ê¸‰í•˜ì„¸ìš”.

ğŸ‘— **ë³´ìœ  ì˜ë¥˜ ë¶„ì„** (ì‚¬ì§„ì—ì„œ í™•ì‹¤íˆ ë³´ì´ëŠ” ê²ƒ)
- ìƒì˜: ì…”ì¸ /í‹°ì…”ì¸ /ë‹ˆíŠ¸ ë“± êµ¬ì²´ì ìœ¼ë¡œ ê°œìˆ˜ê¹Œì§€
- í•˜ì˜: ë°”ì§€/ì¹˜ë§ˆ ë“±
- ì•„ìš°í„°: ì¬í‚·/ì½”íŠ¸ ë“±
- ìƒ‰ìƒ ë¶„í¬ (ì˜ˆ: ë¸”ë™ 40%, í™”ì´íŠ¸ 30%...)
   
ğŸ¨ **ìŠ¤íƒ€ì¼ ì„±í–¥ ë¶„ì„**
- ì „ì²´ì ì¸ ìŠ¤íƒ€ì¼: ìºì£¼ì–¼/í¬ë©€/ìŠ¤íŠ¸ë¦¿ ë“±
- ì„ í˜¸í•˜ëŠ” í•
- ì´ ì˜·ì¥ ì£¼ì¸ì˜ ë¼ì´í”„ìŠ¤íƒ€ì¼ ì¶”ì •
   
ğŸ’« **ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì½”ë”” 3ê°€ì§€**
- ë³´ì´ëŠ” ì˜·ìœ¼ë¡œë§Œ ì¡°í•©
- TPO(ì‹œê°„, ì¥ì†Œ, ìƒí™©)ë³„ë¡œ ì œì•ˆ
- ì•¡ì„¸ì„œë¦¬ ì œì•ˆë„ í¬í•¨
   
ğŸ›ï¸ **ì¶”ì²œ ì‡¼í•‘ ì•„ì´í…œ 2ê°€ì§€**
- í˜„ì¬ ì˜·ì¥ì— ì—†ëŠ”ë° ìˆìœ¼ë©´ ì¢‹ì„ ê²ƒ
- êµ¬ì²´ì ì¸ ì•„ì´í…œëª…ê³¼ ì´ìœ 

ë§Œì•½ ì˜·ì´ ì˜ ì•ˆ ë³´ì´ë©´ "ì˜ë¥˜ê°€ ëª…í™•íˆ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤"ë¼ê³  ë§í•´ì£¼ì„¸ìš”.`,

    whiskey: `ë‹¹ì‹ ì€ ìœ„ìŠ¤í‚¤ ì†Œë¯ˆë¦¬ì—ì´ì ì£¼ë¥˜ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 

**ì¤‘ìš” ì§€ì‹œì‚¬í•­:**
- ì´ ì‚¬ì§„ì€ ìœ„ìŠ¤í‚¤/ì™€ì¸ ì»¬ë ‰ì…˜ ì‚¬ì§„ì…ë‹ˆë‹¤
- ì±…ì´ë‚˜ ë‹¤ë¥¸ ë¬¼ê±´ì´ í•¨ê»˜ ë³´ì—¬ë„ ë¬´ì‹œí•˜ì„¸ìš”
- ì˜¤ì§ ìˆ ë³‘ë§Œ ë¶„ì„í•˜ì„¸ìš”
- ì±… ì œëª©ì„ ìœ„ìŠ¤í‚¤ ì´ë¦„ìœ¼ë¡œ ì°©ê°í•˜ì§€ ë§ˆì„¸ìš”!

ğŸ¥ƒ **ì‹ë³„ëœ ìœ„ìŠ¤í‚¤/ì™€ì¸ ë¶„ì„**

ì‚¬ì§„ ì† ìˆ ë³‘ë“¤ì„ í•˜ë‚˜ì”© ì°¾ì•„ì£¼ì„¸ìš”:
- ë¸Œëœë“œëª… (ë¼ë²¨ì—ì„œ ì½ê¸°, ì˜ˆ: Bisou, Famous Grouse ë“±)
- ì¢…ë¥˜: ìœ„ìŠ¤í‚¤/ì™€ì¸/ë¦¬íë¥´ ë“±
- ìƒì‚°ì§€ì—­
- ë³‘ ìƒ‰ê¹”ê³¼ í˜•íƒœ
- ëŒ€ëµì ì¸ ìš©ëŸ‰

**ì£¼ì˜**: ë§Œì•½ ì±…ì´ë‚˜ ë‹¤ë¥¸ ë¬¼ê±´ì´ ë³´ì´ë©´ "ì´ ì‚¬ì§„ì—ëŠ” ìˆ ë³‘ ì™¸ì— ì±…ë“¤ë„ ë³´ì…ë‹ˆë‹¤ë§Œ, ìˆ ë³‘ë§Œ ë¶„ì„í•˜ê² ìŠµë‹ˆë‹¤"ë¼ê³  ë¨¼ì € ì–¸ê¸‰í•˜ì„¸ìš”.

ğŸŒŸ **ê° ìˆ ì— ëŒ€í•œ ì „ë¬¸ê°€ í‰ê°€**

ê° ìˆ ë³‘ë§ˆë‹¤:
- ì˜ˆìƒë˜ëŠ” í–¥ê³¼ ë§› í”„ë¡œí•„
- ì–´ë–¤ ìƒí™©ì— ì–´ìš¸ë¦¬ëŠ”ì§€
- ê°€ê²©ëŒ€ ì¶”ì •
- ì´ˆë³´ì/ì• í˜¸ê°€ ì í•©ë„

ğŸ½ï¸ **í˜ì–´ë§ ì¶”ì²œ**

ì „ì²´ ì»¬ë ‰ì…˜ì„ ê¸°ë°˜ìœ¼ë¡œ:
- ê° ìˆ ì— ì–´ìš¸ë¦¬ëŠ” ìŒì‹ 3ê°€ì§€ì”©
- ì¹˜ì¦ˆ ë§¤ì¹­
- ì•ˆì£¼ ì¶”ì²œ

ğŸ¯ **ì»¬ë ‰ì…˜ ì´í‰**

- ì´ ì‚¬ëŒì˜ ìˆ  ì·¨í–¥ì€?
- ì»¬ë ‰ì…˜ ìˆ˜ì¤€ í‰ê°€
- ë‹¤ìŒì— ì‚¬ë©´ ì¢‹ì„ ìˆ  2ê°€ì§€ ì¶”ì²œ

ğŸ’¡ **ìŒìš© íŒ**

- ë³´ê´€ ìƒíƒœ ì¡°ì–¸
- ë§ˆì‹œëŠ” ìˆœì„œ ì¶”ì²œ
- ê¸€ë¼ìŠ¤ ì„ íƒ ê°€ì´ë“œ

**ì ˆëŒ€ ê·œì¹™**: ì±… ì œëª©ì´ë‚˜ ë‹¤ë¥¸ ë¬¼ê±´ì„ ìˆ ë¡œ ì°©ê°í•˜ì§€ ë§ˆì„¸ìš”!`

};

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData();
    const mode = formData.get('mode') as string;

    // ì¢…í•© ë¶„ì„ ëª¨ë“œ
    if (mode === 'summary') {
      const type = formData.get('type') as string;
      const analyses = JSON.parse(formData.get('analyses') as string);

      const summaryPrompt = `
ë‹¤ìŒì€ ê°™ì€ ì¥ì†Œì˜ ì—¬ëŸ¬ ì‚¬ì§„ì— ëŒ€í•œ ê°œë³„ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.
ì´ë¥¼ ì¢…í•©í•˜ì—¬ ì „ì²´ì ì¸ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.

${analyses.map((a: string, i: number) => `\n[${i + 1}ë²ˆ ì‚¬ì§„ ë¶„ì„]\n${a}`).join('\n---\n')}

**ì¢…í•© ë¶„ì„ ìš”ì²­:**
1. ì „ì²´ì ì¸ íŒ¨í„´ê³¼ íŠ¹ì§•
2. ê°œë³„ ë¶„ì„ì—ì„œ ë†“ì¹œ ì¸ì‚¬ì´íŠ¸
3. ì „ì²´ë¥¼ ì•„ìš°ë¥´ëŠ” í‰ê°€
4. ì¢…í•© ì¶”ì²œì‚¬í•­

ê°„ê²°í•˜ê³  í•µì‹¬ë§Œ ë‹´ì•„ì£¼ì„¸ìš”!
`;

      const response = await openai.chat.completions.create({
        model: 'gpt-4o',
        messages: [{ role: 'user', content: summaryPrompt }],
        max_tokens: 800,
      });

      return NextResponse.json({ analysis: response.choices[0].message.content });
    }

    // ê°œë³„ ì´ë¯¸ì§€ ë¶„ì„ ëª¨ë“œ
    const image = formData.get('image') as File;
    const type = formData.get('type') as 'bookshelf' | 'fridge' | 'closet' | 'whiskey';
    const imageIndex = formData.get('imageIndex') as string;
    const totalImages = formData.get('totalImages') as string;

    if (!image) {
      return NextResponse.json({ error: 'ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤' }, { status: 400 });
    }

    // ì´ë¯¸ì§€ë¥¼ base64ë¡œ ë³€í™˜
    const bytes = await image.arrayBuffer();
    const buffer = Buffer.from(bytes);
    const base64Image = buffer.toString('base64');
    const mimeType = image.type;

    let prompt = prompts[type];

    // ë‹¤ì¤‘ ì´ë¯¸ì§€ì¸ ê²½ìš° í”„ë¡¬í”„íŠ¸ì— ì •ë³´ ì¶”ê°€
    if (totalImages && parseInt(totalImages) > 1) {
      prompt = `[ì´ë¯¸ì§€ ${imageIndex}/${totalImages}]\n\n` + prompt + `\n\n**ì°¸ê³ **: ì´ê²ƒì€ ${totalImages}ì¥ ì¤‘ ${imageIndex}ë²ˆì§¸ ì‚¬ì§„ì…ë‹ˆë‹¤. ì´ ì‚¬ì§„ì—ì„œ ë³´ì´ëŠ” ê²ƒë§Œ ë¶„ì„í•´ì£¼ì„¸ìš”.`;
    }

    // OpenAI Vision API í˜¸ì¶œ
    const response = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        {
          role: 'user',
          content: [
            { type: 'text', text: prompt },
            {
              type: 'image_url',
              image_url: {
                url: `data:${mimeType};base64,${base64Image}`,
                detail: 'high'
              },
            },
          ],
        },
      ],
      max_tokens: 1500,
    });

    const analysis = response.choices[0].message.content;

    return NextResponse.json({ analysis });
  } catch (error: any) {
    console.error('API Error:', error);
    return NextResponse.json(
      { error: error.message || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
